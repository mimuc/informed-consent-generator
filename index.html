<!doctype html>
<html lang="en">
<head>
    <!-- Required meta tags -->
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <meta http-equiv="content-type" content="text/html; charset=utf-8"/>
    <meta name="author" content="Valentin Schwind">
    <meta name="author" content="Florian Heller">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-9ndCyUaIbzAi2FUVXJi0CjmCapSmO7SnpJef0486qhLnuZ2cdeRhO02iuK6FUUVM" crossorigin="anonymous">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js" integrity="sha384-geWF76RCwLtnZ8qwWowPQNguL3RmwHVBC9FhGdlKrxdiJJigb/j/68SIy3Te4Bkz" crossorigin="anonymous"></script>
    
    <script src="https://cdn.jsdelivr.net/npm/jquery@3.7.0/dist/jquery.min.js"></script>

    <!-- Include Handlebars  -->
    <script src="https://cdn.jsdelivr.net/npm/handlebars@latest/dist/handlebars.js"></script>
    <script src="templates/template_en.precompiled.js"></script>

    <link rel="stylesheet" href="css/style.css" />
    <meta property="og:site_name" content="Informed Consent Generator"> 
    <title>Informed Consent Generator</title>
    <link rel="shortcut icon" href="favicon.ico" type="image/x-icon">
</head>
 <body class="transparent">
    
    <div id="mainFrame" class="vertical-center">
        <a id="downloadAnchorElem" style="display:none"></a>
        <div id="demographicsPage" class="whiteBox container rounded">
            <form id="demographicsForm" class="form-horizontal" action="javascript:generate(this);">
                <div id="input">
                    <div class="row">
                        <div class="col mt-4 mb-2 ">
                            <a id="hostUrl" href=""><img id="hostLogo" class="float-right  mr-3" width="140px" alt="Media Informatics Groups"></a>
                        </div>
                    </div>
                    <div class="row mt-3">
                        <div class="col">
                            <h3 id="demographicsTitle" class="display-6">Informed Consent Generator</h3>
                        </div>
                    </div>
                    <div class="row mt-3">
                        <div class="col mb-1">
                            Obtaining informed consent ensures the users' autonomy and privacy, and that the users are aware of potential risks and benefits of your HCI study. That consent should be freely given, specific, informed and unambiguous by way of a request presented in clear and plain language. Consent should be given by an affirmative act, such as checking a box online or signing the form. Please reach out to your supervisor in case of any requests.
                        </div>
                    </div>
                    <div class="row mt-3">
                        <div class="col mb-1">
                            This informed consent is not suitable for vulnerable groups (children, disabled, prisoners) or when any harm can occur (medical studies). Please consult your local ethics committee. 
                        </div>
                    </div>
                    <hr />
                    <div class="row mt-3 ">
                        <div class="col-4"><label id="institutionText" for="institution" class="danger">Your Institution</label></div>
                        <div class="col-8"><select class="form-control" id="institution" name="institution" onchange="onChange(event)" required></select></div>
                    </div>
                    <div class="row mt-3 ">
                        <div class="col-4"><label id="researchText" for="studyType" class="danger">Kind of research</label></div>
                        <div class="col-8"><select class="form-control" id="studyType" name="type" onchange="onChange(event)" required></select></div>
                    </div>
                    
                    <div class="row mt-3 ">
                        <div class="col-4"><label id="topicText" for="title" class="danger">Title</label></div>
                        <div class="col-8"><input class="form-control" id="title" name="title" onchange="onChange(event)" required /></div>
                    </div> 
                    <div class="row mt-3 ">
                        <div class="col-4"><label id="compensationText"  for="compensation" class="danger">Compensation</label></div>
                        <div class="col-8"><select class="form-control" id="compensation" name="compensation" onchange="onChange(event)" required></select></div>
                    </div>
                    <div class="row mt-3 ">
                        <div class="col-4"><label id="monetaryCompensationText" for="monetaryCompensation" class="danger">Monetary Compensation </label></div>
                        <div class="col-8"><input class="form-control" id="monetaryCompensation" name="monetaryCompensation" onchange="onChange(event)" required /></div>
                    </div>
                    <div class="row mt-3 ">
                        <div class="col-4"><span id="recordingsText">Recorded Data</span></div>
                        <div class="col-8">
                            <div class="row row-cols-3">
                                <div class="col"><input type="checkbox" class="form-check-input" name="recordDemographics" id="recordDemographics" onchange="onChange(event)" checked required><label class="form-check-label" for="recordDemographics">Demographics<span class="text-danger">*</span></label></div>
                                <div class="col"><input type="checkbox" class="form-check-input" name="recordContact" id="recordContact" onchange="onChange(event)"><label class="form-check-label" for="recordContact">Contact information</label></div>
                                <div class="col"><input type="checkbox" class="form-check-input" name="recordInteraction" id="recordInteraction" onchange="onChange(event)"><label class="form-check-label" for="recordInteraction">User Interaction</label></div>
                                <div class="col"><input type="checkbox" class="form-check-input" name="recordAudio" id="recordAudio" onchange="onChange(event)"><label class="form-check-label" for="recordAudio">Audio</label></div>
                                <div class="col"><input type="checkbox" class="form-check-input" name="recordPhotos" id="recordPhotos" onchange="onChange(event)"><label class="form-check-label" for="recordPhotos">Photos</label></div>
                                <div class="col"><input type="checkbox" class="form-check-input" name="recordVideos" id="recordVideos" onchange="onChange(event)"><label class="form-check-label" for="recordVideos">Videos</label></div>
                                <div class="col"><input type="checkbox" class="form-check-input" name="recordMotion" id="recordMotion" onchange="onChange(event)"><label class="form-check-label" for="recordMotion">Motion Tracking</label></div>
                                <div class="col"><input type="checkbox" class="form-check-input" name="recordPhysiological" id="recordPhysiological" onchange="onChange(event)"><label class="form-check-label" for="recordPhysiological">Physio. Sensing</label></div>
                                <div class="col"><input type="checkbox" class="form-check-input" name="recordEyetracking" id="recordEyetracking" onchange="onChange(event)"><label class="form-check-label" for="recordEyetracking">Eye/Head Tracking</label></div>
                                <div class="col"><input type="checkbox" class="form-check-input" name="recordScreenrecording" id="recordScreenrecording" onchange="onChange(event)"><label class="form-check-label" for="recordScreenrecording">Screen Recording</label></div>
                            </div>
                        </div>                      
                    </div> 
                    <div class="row mt-3 ">
                        <div class="col-4"><label id="personalDataText" for="personalData" class="danger">Which personal data will be collected? (list all)</label></div>
                        <div class="col-8"><input class="form-control"  id="personalData" name="personalData" onchange="onChange(event)" required /></div>
                    </div>
                    <div class="row mt-3 ">
                        <div class="col-4"><label id="storageTimeText" for="storageTime" class="danger">How long will the data stored with the researchers?</label></div>
                        <div class="col-8"><input class="form-control" id="storageTime" name="storageTime" onchange="onChange(event)" required /></div>
                    </div>
                    <div class="row mt-3 ">
                        <div class="col-4"><label id="shareText" for="share" class="danger">Do you make the raw data public?</label></div>
                        <div class="col-8"><select class="form-control" id="share"  name="share" onchange="onChange(event)" required></select></div>
                    </div>
                    <div class="row mt-3 ">
                        <div class="col-4"><label id="encryptionText" for="encryption" class="danger">Will the data be stored encrypted?</label></div>
                        <div class="col-8"><select class="form-control" id="encryption" name="encryption" onchange="onChange(event)" required></select></div>
                    </div>
                    <div class="row mt-3 ">
                        <div class="col-4"><label id="durationText" for="duration" class="danger">Estimated Study Duration</label></div>
                        <div class="col-8"><input class="form-control" id="duration" name="duration" onchange="onChange(event)" required /></div>
                    </div> 
                    <div class="row mt-3 ">
                        <div class="col-4"><label id="numberOfParticipantsText" for="participants" class="danger">Estimated Number of Participants</label></div>
                        <div class="col-8"><input class="form-control" id="participants" name="participants" onchange="onChange(event)" required /></div>
                    </div> 
                    <div class="row mt-3 ">
                        <div class="col-4"><label id="purposeText" for="purpose" class="danger">Purpose (one sentence)</label></div>
                        <div class="col-8"><input class="form-control" id="purpose" name="purpose" onchange="onChange(event)" required /></div>
                    </div> 
                    <div class="row mt-3 ">
                        <div class="col-4"><label id="goalText" for="goal" class="danger">Goal (one sentence)</label></div>
                        <div class="col-8"><input class="form-control" id="goal" name="goal" onchange="onChange(event)" required  /></div>
                    </div> 
                    <div class="row mt-3 ">
                        <div class="col-4"><label id="procedureText" for="procedure" class="danger">Procedure (in 4-6 steps)</label></div>
                        <div class="col-8"><textarea rows="4" class="form-control" id="procedure" name="procedure" onchange="onChange(event)" required></textarea></div>
                    </div> 
                    <div class="row mt-3 ">
                        <div class="col-4"><label id="thePInameLabel" for="thePIname" class="danger">First Researchers' Name (The PI)</label></div>
                        <div class="col-8"><input class="form-control" id="thePIname" name="thePIname" onchange="onChange(event)" required /></div>
                    </div>
                    <div class="row mt-3 ">
                        <div class="col-4"><label id="thePIemailLabel" for="thePIemail" class="danger">First Researchers' E-Mail</label></div>
                        <div class="col-8"><input class="form-control" type="email" id="thePIemail" name="thePIemail" onchange="onChange(event)" required /></div>
                    </div>
                    <div class="row mt-3 ">
                        <div class="col-4"><label id="PIText" for="departmentHead">Head of the Department (if not = PI)</label></div>
                        <div class="col-8"><input class="form-control" id="departmentHead" name="departmentHead" onchange="onChange(event)" /></div>
                    </div>
                    <div class="row mt-3" id="addResearchersContainer">
                        <div class="col-4"><span id="additionalResearchers" class="danger">All other researchers' involved</span></div>
                        <div class="col-8"><button class="btn btn-success" id="btnAddResearcher" type="button" >+ Add Additional Researcher</button></div>
                    </div>
                    <div class="row mt-3 ">
                        <div class="col-4"><label id="fundingLabel" for="funding">Funding</label></div>
                        <div class="col-8"><input class="form-control" id="funding" name="funding" onchange="onChange(event)" /></div>
                    </div>
                    <div class="row mt-3 ">
                        <div class="col-4"><label id="ethicalComitteeText" for="ethicalComittee">Ethical Committee</label></div>
                        <div class="col-8"><input class="form-control" id="ethicalComittee" name="ethicalComittee" onchange="onChange(event)" /></div>
                    </div>
                    </div>
                    <div class="row mt-3 mb-3 itemRow" id="fieldsrequired">
                        <div class="col" >
                            <span class="text-danger">* required fields</span> <br />
                        </div>
                    </div>
                    <hr class="uiEdit">
                    <div class="row mt-3 itemRow uiEdit">
                        <div class="col-8">
                            <a id="btnExample" class="btn btn-secondary btn-md float-left mr-3 " >Example</a> 
                            <a id="btnSave" class="btn btn-secondary btn-md float-left mr-3 btnSave" >Save Settings (*.json)</a>
                            <a id="btnLoad" class="btn btn-secondary btn-md float-left mr-3">Load Settings (*.json)</a>
                            <input class="form-control form-control-sm" id="fileInput" type="file" style='display: none;'>
                        </div>
                        <div class="d-grid gap-2 col-4 mx-auto">
                            <button id="btnGenerate" class="btn btn-primary btn-md float-right" type="Submit" value="">Generate From</button>
                        </div>
                    </div>

                    <div class="row mt-2 itemRow uiView">
                        <div class="col" >
                            <button id="btnBack" class="btn btn-primary btn-md float-left btnBack" >Back</button> 
                            <button id="btnSave" class="btn btn-secondary btn-md float-left mr-3 btnSave" >Save (*.json)</button>
                            <button id="btnPrint" class="btn btn-primary btn-md float-right" value="">Print</button>
                        </div>
                    </div>
                <div id="results"></div>
                <div class="row mt-2 mb-2 itemRow" id="githublink">
                    <div class="row mt-2 itemRow uiView">
                        <div class="col" >
                            <button id="btnBack" class="btn btn-primary btn-md float-left btnBack" >Back</button>
                        </div>
                    </div>
                    <div class="col" >
                        <small><a href="https://github.com/interactionlab/informed-consent-generator/">Original Source Code on GitHub</a></small><small> running <span id="version"></span></small>
                    </div>
                </div>
            </form>
        </div>        
    </div>

    <script src="./templating.js"></script>
    <script>

        function onChange(event){
            data = collectData();
        }

        function capitalize(s)
        {
            return s && s[0].toUpperCase() + s.slice(1);
        }

        function capital_letter(str) {
            str = str.replace(/\s\s+/g, ' ');
            str = str.split(" ");
            for (var i = 0, x = str.length; i < x; i++) {
                str[i] = str[i][0].toUpperCase() + str[i].substr(1);
            }
            return str.join(" ");
        }

        function downloadObjectAsJson(data, fileName){
            var dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(data, null, 4));
            var downloadAnchorNode = document.createElement('a');
            downloadAnchorNode.setAttribute("href", dataStr);
            downloadAnchorNode.setAttribute("download", fileName);
            document.body.appendChild(downloadAnchorNode); // required for firefox
            downloadAnchorNode.click();
            downloadAnchorNode.remove();
        }

        function getCookie(name) {
            var nameEQ = name + "=";
            var ca = document.cookie.split(';');
            for(var i=0;i < ca.length;i++) {
                var c = ca[i];
                while (c.charAt(0)==' ') c = c.substring(1,c.length);
                if (c.indexOf(nameEQ) == 0) return c.substring(nameEQ.length,c.length);
            }
            return null;
        }

        var inputKeys = ["title", "duration", "personalData", "storageTime", "purpose", "goal", "departmentHead", "thePIname", "thePIemail", "participants", "monetaryCompensation", "ethicalComittee", "funding"];
        var inputRecord = ["demographics", "contact", "audio", "photos", "videos", "motion", "physiological", "eyetracking", "screenrecording", "notes", "interaction"];

        function myXOR(a,b) {
          return ( a || b ) && !( a && b );
        }

        function fillSelect(){
            document.getElementById("version").innerHTML = settings["version"];

            $("select[name='institution']").append(new Option(settings["hints"]["select"], ""));
            for (let key in settings["institutions"]) {
                let institution = settings["institutions"][key]
                $("select[name='institution']").append(new Option(institution["name"], institution["name"]));
            }

            $("select[name='type']").append(new Option(settings["hints"]["select"], ""));
            for (let i = 0; i < settings["types"].length; i++) {
                type = settings["types"][i]
                $("select[name='type']").append(new Option(type[0], type[1]));
            }
            
            $("select[name='share']").append(new Option(settings["hints"]["select"], ""));
            for (let i = 0; i < settings["dataShare"].length; i++) {
                share = settings["dataShare"][i]
                $("select[name='share']").append(new Option(share[0], share[1]));
            }

            $("select[name='encryption']").append(new Option(settings["hints"]["select"], ""));
            for (let i = 0; i < settings["dataEncryption"].length; i++) {
                encryption = settings["dataEncryption"][i]
                $("select[name='encryption']").append(new Option(encryption[0], encryption[1]));
            }

            $("select[name='compensation']").append(new Option(settings["hints"]["select"], ""));
            for (let i = 0; i < settings["compensation"].length; i++) {
                compensation = settings["compensation"][i]
                $("select[name='compensation']").append(new Option(compensation[0], compensation[1]));
            }
            
            var hints = settings["hints"]
            for (let key in hints) {
                if (key === "select"){
                    //None
                }
                else if (key === "procedure"){
                    $("textarea[name='" + key + "'] ").attr("placeholder", hints[key]);
                } else {
                    $("input[name='" + key + "'] ").attr("placeholder", hints[key]);
                }
            }


            $("#hostUrl").attr("href", settings["hostUrl"]);
            $("#hostLogo").attr("src", "img/" + settings["hostLogo"]);

            let cookieData = getCookie("data");

            if (cookieData != null){
                cookieData = JSON.parse(cookieData);
                fillData(cookieData);
            } else {
                for (let i = 0; i < settings["researcherCount"]; i++){
                    addResearcher();
                }
            }
        }

        function addResearcher (){
            var lstResearchers = document.getElementsByClassName("researchersContainer");
                var lastElement = null;
                if (lstResearchers.length === 0){
                    lastElement = document.getElementById("addResearchersContainer");
                } else {
                    lastElement = lstResearchers[lstResearchers.length-1];
                }
                var link = `<div class="row mt-3 researchersContainer">
                        <div class="col-4"></div>
                        <div class="col-8">
                            <div class="row mt-3">
                                <div class="col-2"><span class="researcherName danger">Name</span></div>
                                <div class="col-10">
                                    <div class="input-group">
                                    <input class="form-control" name="researcherName" onchange="onChange(event)" required />
                                    <button class="btn btn-danger btnRemoveResearcher" onclick="removeResearcher(1)" type="button">-</button>
                                    </div>
                                </div>    
                            </div>
                            <div class="row mt-3">
                                <div class="col-2"><span class="researcherEmail danger">E-Mail</span></div>
                                <div class="col-10"><input class="form-control" name="researcherEmail"  type="email" onchange="onChange(event)" required />
                                </div>
                            </div>
                        </div>
                    </div>`;
                lastElement.insertAdjacentHTML("afterend", link);
                correctResercherNumbers();
        }

        function removeResearcher(value){
            var lstResearchers = document.getElementsByClassName("researchersContainer");
            if (lstResearchers.length > 0){
                lstResearchers[value].remove();
            }
            correctResercherNumbers();
            data = collectData();
        }

        function correctResercherNumbers (){
            var lstResearchers = document.getElementsByClassName("researcherName");
            for (var i = 0; i < lstResearchers.length; i++){
                var researcherName = lstResearchers[i];
                researcherName.innerHTML = "Name " + (i+1);
            }
            var lstResearchers = document.getElementsByClassName("btnRemoveResearcher");
            for (var i = 0; i < lstResearchers.length; i++){
                var researcherName = lstResearchers[i];
                researcherName.setAttribute("onclick", "removeResearcher(" + (i) + ")"); 
            }
            var lstResearchers = document.getElementsByClassName("researcherEmail");
            for (var i = 0; i < lstResearchers.length; i++){
                var researcherName = lstResearchers[i];
                researcherName.innerHTML = "E-mail " + (i+1);
            }
        }
        
        function fillData(data){
            $("textarea[name='procedure']").val(data["procedure"]);
            var record = data["record"];
            for (let key in record) {
                $("input[name='record" + capitalize(key) + "']").prop("checked", record[key]);
            }
            
            inputKeys.forEach((key) => {
                $("input[name='" + key + "']").val(data[key]);
            });

            $("select[name='institution'] option[value='" + data["institution"] + "']").attr("selected", true);
            $("select[name='type'] option[value='" + data["type"] + "']").attr("selected", true);
            $("select[name='share'] option[value='" + data["share"] + "']").attr("selected", true);
            $("select[name='encryption'] option[value='" + data["encryption"] + "']").attr("selected", true);
            $("select[name='compensation'] option[value='" + data["compensation"] + "']").attr("selected", true);

            document.querySelectorAll(".researchersContainer").forEach(el => el.remove());
            if (data["researchers"] != null){
                data["researchers"].forEach((researcher) => {
                    addResearcher();
                    var lstResearchers = document.getElementsByClassName("researchersContainer");
                    var lastElement = lstResearchers[lstResearchers.length-1];
                    lastElement.getElementsByClassName("form-control")[0].value = researcher["name"];
                    lastElement.getElementsByClassName("form-control")[1].value = researcher["email"];
                });
            }
        }



        const makeCommaSeparatedString = (arr, andSeparator, useOxfordComma) => {
            const listStart = arr.slice(0, -1).join(', ');
            const listEnd = arr.slice(-1);
            const conjunction = arr.length <= 1 ? '' : useOxfordComma && arr.length > 2 ? ', ' + andSeparator + ' ' : ' ' + andSeparator + ' ';
            return [listStart, listEnd].join(conjunction)
        }

        function generate(){

            $(".uiView").show();
            $(".uiEdit").hide();
            $("#input").hide();
            $("#fieldsrequired").hide();
          
            var template = Handlebars.templates.template_en;
            data = collectData();
          
            let institution = settings["institutions"][data["institution"]]
            if (template != null) {
                let result = template({...data, ...institution});
                $("#results").html(result);
            }

            setTimeout(function () {
                     // window.print();
                 }, 100);
        }

        var settings = {};
        var data = {};
        $(document).ready(function() {
            
            fetch('./settings.json')
                .then((response)=>response.json())
                .then((responseJson)=>{settings = responseJson; fillSelect();});

            $(".uiEdit").show();
            $(".uiView").hide();
            $(".btnBack").click(function(e){
                e.preventDefault();
                $(".uiEdit").show();
                $(".uiView").hide();
                $("#input").show(); 
                $("#fieldsrequired").show();
                $("#btnGenerate").show();
                $("#results").html("");
            });
            
            $("#btnPrint").click(function(e){
                $('.print_special').css({ border : 'none'});
                window.print(); 
                e.preventDefault();
            });

            $("#btnAddResearcher").click(function(e){addResearcher ();});
            
            $(".btnSave").click(function() {
                data = collectData();
                downloadObjectAsJson(data, "exportInformedConsent.json");
            });

            $("#btnLoad").click(function() {
                $("#fileInput").click();
            });

            $('#fileInput').change(function (e) { 
                var [file] = document.querySelector('#fileInput').files;
                var reader = new FileReader();

                reader.onload = function(event) {
                    var jsonObj = JSON.parse(event.target.result);
                    data = jsonObj;
                    fillData(data);
                };

                reader.readAsText(event.target.files[0]);
            });

            $("#btnExample").click(function() {
                fetch('./example.json')
                    .then((response)=>response.json())
                    .then((example)=>{fillData(example);data = collectData();});
            });

        });
         
    </script>
 </body>
</html>